import"./modulepreload-polyfill-B5Qt9EMX.js";import{C as S}from"./cpf-validator-B4PsRAE6.js";import{D as $}from"./database-CTJo1PQf.js";class k{constructor(){this.dbService=new $,this.leads=[],this.filteredLeads=[],this.selectedLeads=new Set,this.currentPage=1,this.leadsPerPage=20,this.isLoggedIn=!1,this.systemMode="auto",this.bulkData=[],this.bulkResults=null,this.editingLead=null,console.log("🔧 AdminPanel inicializado - Modo Local"),this.init()}async init(){console.log("🚀 Inicializando painel administrativo...");try{this.setupEventListeners(),this.checkLoginStatus(),this.isLoggedIn&&(this.loadLeads(),this.renderLeadsTable(),this.updateLeadsCount()),console.log("✅ Painel administrativo inicializado com sucesso")}catch(e){console.error("❌ Erro na inicialização do painel:",e)}}setupEventListeners(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",u=>this.handleLogin(u));const t=document.getElementById("logoutButton");t&&t.addEventListener("click",()=>this.handleLogout());const o=document.getElementById("showLeadsView");o&&o.addEventListener("click",()=>this.showView("leadsView"));const a=document.getElementById("showAddLeadView");a&&a.addEventListener("click",()=>this.showView("addLeadView"));const s=document.getElementById("showBulkAddView");s&&s.addEventListener("click",()=>this.showView("bulkAddView"));const i=document.getElementById("addLeadForm");i&&i.addEventListener("submit",u=>this.handleAddLead(u));const n=document.getElementById("previewBulkDataButton");n&&n.addEventListener("click",()=>this.previewBulkData());const d=document.getElementById("clearBulkDataButton");d&&d.addEventListener("click",()=>this.clearBulkData());const r=document.getElementById("confirmBulkImportButton");r&&r.addEventListener("click",()=>this.confirmBulkImport());const c=document.getElementById("editBulkDataButton");c&&c.addEventListener("click",()=>this.editBulkData());let l=document.getElementById("refreshButton");l&&l.addEventListener("click",()=>this.refreshLeads());const g=document.getElementById("applyFiltersButton");g&&g.addEventListener("click",()=>this.applyFilters());const m=document.getElementById("massNextStage");m&&m.addEventListener("click",()=>this.handleMassAction("nextStage"));const p=document.getElementById("massPrevStage");p&&p.addEventListener("click",()=>this.handleMassAction("prevStage"));const h=document.getElementById("massSetStage");h&&h.addEventListener("click",()=>this.handleMassAction("setStage"));const f=document.getElementById("massDeleteLeads");f&&f.addEventListener("click",()=>this.handleMassAction("delete"));const y=document.getElementById("nextAllButton");y&&y.addEventListener("click",()=>this.handleSystemAction("nextAll"));const v=document.getElementById("prevAllButton");v&&v.addEventListener("click",()=>this.handleSystemAction("prevAll")),l=document.getElementById("refreshButton"),l&&l.addEventListener("click",()=>this.handleSystemAction("refresh"));const L=document.getElementById("clearAllButton");L&&L.addEventListener("click",()=>this.handleSystemAction("clearAll"));const E=document.getElementById("closeEditModal");E&&E.addEventListener("click",()=>this.closeEditModal());const b=document.getElementById("cancelEdit");b&&b.addEventListener("click",()=>this.closeEditModal());const x=document.getElementById("editForm");x&&x.addEventListener("submit",u=>this.handleEditSubmit(u))}checkLoginStatus(){localStorage.getItem("admin_logged_in")==="true"?(this.isLoggedIn=!0,this.showAdminPanel()):this.showLoginScreen()}handleLogin(e){e.preventDefault(),this.isLoggedIn=!0,localStorage.setItem("admin_logged_in","true"),this.showAdminPanel(),this.loadLeads()}handleLogout(){this.isLoggedIn=!1,localStorage.removeItem("admin_logged_in"),this.showLoginScreen()}showLoginScreen(){const e=document.getElementById("loginScreen"),t=document.getElementById("adminPanel");e&&(e.style.display="flex"),t&&(t.style.display="none")}showAdminPanel(){const e=document.getElementById("loginScreen"),t=document.getElementById("adminPanel");e&&(e.style.display="none"),t&&(t.style.display="block"),this.showView("leadsView")}showView(e){document.querySelectorAll(".admin-view").forEach(i=>{i.style.display="none"}),document.querySelectorAll(".nav-button").forEach(i=>{i.classList.remove("active")});const a=document.getElementById(e);a&&(a.style.display="block");const s=document.getElementById(`show${e.charAt(0).toUpperCase()+e.slice(1)}`);s&&s.classList.add("active")}loadLeads(){try{console.log("📊 Carregando leads do localStorage...");const e=localStorage.getItem("leads");this.leads=e?JSON.parse(e):[],this.filteredLeads=[...this.leads],console.log(`📦 ${this.leads.length} leads carregados do localStorage`),this.renderLeadsTable(),this.updateLeadsCount()}catch(e){console.error("❌ Erro ao carregar leads do localStorage:",e),this.leads=[],this.filteredLeads=[],this.renderLeadsTable(),this.updateLeadsCount()}}handleAddLead(e){var a,s,i,n,d,r,c,l;e.preventDefault();const t=new FormData(e.target),o={nome_completo:t.get("nome")||((a=document.getElementById("addLeadNome"))==null?void 0:a.value),cpf:(i=t.get("cpf")||((s=document.getElementById("addLeadCPF"))==null?void 0:s.value))==null?void 0:i.replace(/[^\d]/g,""),email:t.get("email")||((n=document.getElementById("addLeadEmail"))==null?void 0:n.value),telefone:t.get("telefone")||((d=document.getElementById("addLeadTelefone"))==null?void 0:d.value),endereco:this.buildAddress(t),produtos:[{nome:t.get("produto")||((r=document.getElementById("addLeadProduto"))==null?void 0:r.value)||"Kit 12 caixas organizadoras + brinde",preco:parseFloat(t.get("valor")||((c=document.getElementById("addLeadValor"))==null?void 0:c.value)||0)}],valor_total:parseFloat(t.get("valor")||((l=document.getElementById("addLeadValor"))==null?void 0:l.value)||0),meio_pagamento:"PIX",origem:"direto",etapa_atual:1,status_pagamento:"pendente",order_bumps:[],data_compra:new Date().toISOString(),created_at:new Date().toISOString(),updated_at:new Date().toISOString()};this.saveLeadToLocalStorage(o),this.loadLeads(),this.showView("leadsView"),e.target.reset(),this.showNotification("Lead criado com sucesso!","success")}saveLeadToLocalStorage(e){try{const t=JSON.parse(localStorage.getItem("leads")||"[]");e.id=Date.now().toString(),t.push(e),localStorage.setItem("leads",JSON.stringify(t)),console.log("✅ Lead salvo no localStorage")}catch(t){console.error("❌ Erro ao salvar lead:",t)}}buildAddress(e){var c,l,g,m,p,h,f,y;const t=e.get("endereco")||((c=document.getElementById("addLeadEndereco"))==null?void 0:c.value)||"",o=e.get("numero")||((l=document.getElementById("addLeadNumero"))==null?void 0:l.value)||"",a=e.get("complemento")||((g=document.getElementById("addLeadComplemento"))==null?void 0:g.value)||"",s=e.get("bairro")||((m=document.getElementById("addLeadBairro"))==null?void 0:m.value)||"",i=e.get("cep")||((p=document.getElementById("addLeadCEP"))==null?void 0:p.value)||"",n=e.get("cidade")||((h=document.getElementById("addLeadCidade"))==null?void 0:h.value)||"",d=e.get("estado")||((f=document.getElementById("addLeadEstado"))==null?void 0:f.value)||"",r=e.get("pais")||((y=document.getElementById("addLeadPais"))==null?void 0:y.value)||"BR";return`${t}, ${o}${a?` - ${a}`:""} - ${s} - ${n}/${d} - CEP: ${i} - ${r}`}previewBulkData(){const e=document.getElementById("bulkDataTextarea");if(!e||!e.value.trim()){this.showNotification("Por favor, cole os dados na caixa de texto","error");return}try{this.bulkData=this.parseBulkData(e.value),this.displayBulkPreview()}catch(t){console.error("❌ Erro ao processar dados:",t),this.showNotification("Erro ao processar dados: "+t.message,"error")}}parseBulkData(e){const t=e.trim().split(`
`).filter(i=>i.trim()),o=[],a=new Set,s=[];for(let i=0;i<t.length;i++){const n=t[i].trim();if(!n)continue;const d=n.split(/\t+|\s{2,}/).map(I=>I.trim());if(d.length<4){console.warn(`Linha ${i+1} ignorada: poucos campos`);continue}const[r,c,l,g,m,p,h,f,y,v,L,E,b,x]=d,u=(g||"").replace(/[^\d]/g,"");if(a.has(u)){s.push({nome:r,cpf:u});continue}a.add(u);const B=this.buildAddressFromFields({rua:h||"",numero:f||"",complemento:y||"",bairro:v||"",cep:L||"",cidade:E||"",estado:b||"",pais:x||"BR"});o.push({nome_completo:r||"",email:c||"",telefone:l||"",cpf:u,produto:m||"Kit 12 caixas organizadoras + brinde",valor_total:parseFloat(p)||67.9,endereco:B,meio_pagamento:"PIX",origem:"direto",etapa_atual:1,status_pagamento:"pendente",order_bumps:[],produtos:[{nome:m||"Kit 12 caixas organizadoras + brinde",preco:parseFloat(p)||67.9}],lineNumber:i+1})}return console.log(`📊 Dados processados: ${o.length} leads, ${s.length} duplicatas removidas`),{leads:o,duplicatesRemoved:s}}buildAddressFromFields({rua:e,numero:t,complemento:o,bairro:a,cep:s,cidade:i,estado:n,pais:d}){return`${e}, ${t}${o?` - ${o}`:""} - ${a} - ${i}/${n} - CEP: ${s} - ${d}`}displayBulkPreview(){const e=document.getElementById("bulkPreviewSection"),t=document.getElementById("bulkPreviewContainer"),o=document.getElementById("confirmBulkImportButton"),a=document.getElementById("previewSummary");if(!e||!t)return;e.style.display="block";let s=`
            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Nome</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Email</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Telefone</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">CPF</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Produto</th>
                        <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Valor</th>
                    </tr>
                </thead>
                <tbody>
        `;this.bulkData.leads.forEach((i,n)=>{const d=n%2===0?"background: #f9f9f9;":"";s+=`
                <tr style="${d}">
                    <td style="padding: 6px; border: 1px solid #ddd;">${i.nome_completo}</td>
                    <td style="padding: 6px; border: 1px solid #ddd;">${i.email}</td>
                    <td style="padding: 6px; border: 1px solid #ddd;">${i.telefone}</td>
                    <td style="padding: 6px; border: 1px solid #ddd;">${S.formatCPF(i.cpf)}</td>
                    <td style="padding: 6px; border: 1px solid #ddd;">${i.produto}</td>
                    <td style="padding: 6px; border: 1px solid #ddd;">R$ ${i.valor_total.toFixed(2)}</td>
                </tr>
            `}),s+="</tbody></table>",this.bulkData.duplicatesRemoved.length>0&&(s+=`
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
                    <strong>📋 Duplicatas Removidas (${this.bulkData.duplicatesRemoved.length}):</strong>
                    <ul style="margin: 5px 0 0 20px;">
                        ${this.bulkData.duplicatesRemoved.map(i=>`<li>${i.nome} - CPF: ${this.formatCPF(i.cpf)}</li>`).join("")}
                    </ul>
                </div>
            `),t.innerHTML=s,a&&(a.textContent=`${this.bulkData.leads.length} leads para importar${this.bulkData.duplicatesRemoved.length>0?`, ${this.bulkData.duplicatesRemoved.length} duplicatas removidas`:""}`),o&&(o.style.display="inline-block")}async confirmBulkImport(){if(!this.bulkData||!this.bulkData.leads.length){this.showNotification("Nenhum dado para importar","error");return}const e=document.getElementById("confirmBulkImportButton");if(!e)return;const t=e.innerHTML;e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Importando...',e.disabled=!0;try{const o=await this.processBulkImport();this.displayBulkResults(o)}catch(o){console.error("❌ Erro na importação em massa:",o),this.showNotification("Erro na importação: "+o.message,"error")}finally{e.innerHTML=t,e.disabled=!1}}processBulkImport(){const e={success:[],errors:[],total:this.bulkData.leads.length};return this.bulkData.leads.forEach(t=>{try{const o=this.validateLeadData(t);if(!o.isValid){e.errors.push({nome:t.nome_completo,cpf:t.cpf,error:o.error,type:"validation"});return}const a=JSON.parse(localStorage.getItem("leads")||"[]");if(a.find(i=>i.cpf===t.cpf)){e.errors.push({nome:t.nome_completo,cpf:t.cpf,error:"CPF já existe no sistema",type:"duplicate"});return}t.id=Date.now().toString()+Math.random().toString(36).substr(2,9),a.push(t),localStorage.setItem("leads",JSON.stringify(a)),e.success.push({nome:t.nome_completo,cpf:t.cpf,id:t.id})}catch(o){e.errors.push({nome:t.nome_completo,cpf:t.cpf,error:o.message,type:"exception"})}}),e}validateLeadData(e){return!e.nome_completo||e.nome_completo.trim().length<2?{isValid:!1,error:"Nome completo é obrigatório (mínimo 2 caracteres)"}:!e.email||!this.isValidEmail(e.email)?{isValid:!1,error:"Email é obrigatório e deve ter formato válido"}:!e.telefone||e.telefone.length<10?{isValid:!1,error:"Telefone é obrigatório (mínimo 10 dígitos)"}:!e.cpf||e.cpf.length!==11?{isValid:!1,error:"CPF é obrigatório e deve ter 11 dígitos"}:this.isValidCPF(e.cpf)?{isValid:!0}:{isValid:!1,error:"CPF inválido (formato ou dígitos verificadores incorretos)"}}isValidCPF(e){const t=e.replace(/[^\d]/g,"");return!(t.length!==11||/^(\d)\1{10}$/.test(t))}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}displayBulkResults(e){const t=document.getElementById("bulkResultsSection"),o=document.getElementById("bulkResultsContainer");if(!t||!o)return;t.style.display="block";let a=`
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
        `;a+=`
            <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px;">
                <h4 style="color: #155724; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-check-circle"></i>
                    Pedidos Postados com Sucesso (${e.success.length})
                </h4>
        `,e.success.length>0?(a+='<ul style="margin: 0; padding-left: 20px; max-height: 200px; overflow-y: auto;">',e.success.forEach(n=>{a+=`<li style="margin-bottom: 5px; color: #155724;">
                    <strong>${n.nome}</strong> - CPF: ${S.formatCPF(n.cpf)}
                </li>`}),a+="</ul>",a+=`
                <div style="margin-top: 15px; text-align: center;">
                    <button id="goToLeadsListButton" style="
                        background: #28a745;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#218838'" onmouseout="this.style.background='#28a745'">
                        <i class="fas fa-list"></i> Ir para Lista
                    </button>
                </div>
            `):a+='<p style="color: #856404; font-style: italic;">Nenhum pedido foi postado com sucesso.</p>',a+="</div>",a+=`
            <div style="background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 8px; padding: 20px;">
                <h4 style="color: #721c24; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Pedidos com Erro (${e.errors.length})
                </h4>
        `,e.errors.length>0?(a+=`
                <div style="max-height: 200px; overflow-y: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                        <thead>
                            <tr style="background: #f5c6cb;">
                                <th style="padding: 6px; border: 1px solid #f1b0b7; text-align: left;">Nome</th>
                                <th style="padding: 6px; border: 1px solid #f1b0b7; text-align: left;">CPF</th>
                                <th style="padding: 6px; border: 1px solid #f1b0b7; text-align: left;">Motivo do Erro</th>
                            </tr>
                        </thead>
                        <tbody>
            `,e.errors.forEach((n,d)=>{const r=d%2===0?"background: #fdf2f2;":"";a+=`
                    <tr style="${r}">
                        <td style="padding: 6px; border: 1px solid #f1b0b7;">${n.nome}</td>
                        <td style="padding: 6px; border: 1px solid #f1b0b7;">${this.formatCPF(n.cpf)}</td>
                        <td style="padding: 6px; border: 1px solid #f1b0b7; color: #721c24;">
                            <strong>${this.getErrorTypeLabel(n.type)}:</strong> ${n.error}
                        </td>
                    </tr>
                `}),a+="</tbody></table></div>"):a+='<p style="color: #155724; font-style: italic;">Nenhum erro encontrado! 🎉</p>',a+="</div></div>",a+=`
            <div style="background: #e2e3e5; border: 1px solid #d6d8db; border-radius: 8px; padding: 15px; text-align: center;">
                <h4 style="color: #383d41; margin-bottom: 10px;">📊 Resumo da Importação</h4>
                <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <strong style="color: #28a745;">${e.success.length}</strong>
                        <span style="color: #6c757d;"> Sucessos</span>
                    </div>
                    <div>
                        <strong style="color: #dc3545;">${e.errors.length}</strong>
                        <span style="color: #6c757d;"> Erros</span>
                    </div>
                    <div>
                        <strong style="color: #007bff;">${e.total}</strong>
                        <span style="color: #6c757d;"> Total Processados</span>
                    </div>
                    <div>
                        <strong style="color: #ffc107;">${this.bulkData.duplicatesRemoved.length}</strong>
                        <span style="color: #6c757d;"> Duplicatas Removidas</span>
                    </div>
                </div>
            </div>
        `,o.innerHTML=a;const s=document.getElementById("goToLeadsListButton");s&&s.addEventListener("click",()=>{this.showView("leadsView"),this.refreshLeads()});const i=document.getElementById("bulkPreviewSection");i&&(i.style.display="none"),this.bulkResults=e}getErrorTypeLabel(e){return{validation:"Dados Inválidos",duplicate:"Duplicidade",database:"Erro de Banco",exception:"Erro Interno"}[e]||"Erro"}clearBulkData(){const e=document.getElementById("bulkDataTextarea"),t=document.getElementById("bulkPreviewSection"),o=document.getElementById("bulkResultsSection");e&&(e.value=""),t&&(t.style.display="none"),o&&(o.style.display="none"),this.bulkData=[],this.bulkResults=null}editBulkData(){const e=document.getElementById("bulkPreviewSection");e&&(e.style.display="none");const t=document.getElementById("bulkDataTextarea");t&&t.focus()}refreshLeads(){console.log("🔄 Atualizando lista de leads..."),this.loadLeads(),this.showNotification("Lista atualizada com sucesso!","success")}applyFilters(){console.log("🔍 Aplicando filtros...");const e=document.getElementById("searchInput"),t=document.getElementById("dateFilter"),o=document.getElementById("stageFilter"),a=e?e.value.toLowerCase().trim():"",s=t?t.value:"",i=o?o.value:"all";console.log("Filtros aplicados:",{searchTerm:a,dateValue:s,stageValue:i}),this.filteredLeads=this.leads.filter(n=>{if(a){const d=(n.nome_completo||"").toLowerCase().includes(a),r=(n.cpf||"").replace(/[^\d]/g,"").includes(a.replace(/[^\d]/g,""));if(!d&&!r)return!1}if(s){const d=new Date(n.created_at),r=new Date(s);if(d.toDateString()!==r.toDateString())return!1}return!(i!=="all"&&(n.etapa_atual||1).toString()!==i)}),console.log(`Filtros aplicados: ${this.filteredLeads.length} de ${this.leads.length} leads`),this.currentPage=1,this.renderLeadsTable(),this.updateLeadsCount(),this.showNotification(`Filtros aplicados: ${this.filteredLeads.length} leads encontrados`,"info")}async handleSystemAction(e){console.log(`🔧 Executando ação do sistema: ${e}`),this.applyFilters();const t=this.filteredLeads;if(e==="refresh"){this.showLoadingButton("refreshButton","Atualizando...");try{this.refreshLeads(),this.showNotification("Lista atualizada com sucesso!","success")}finally{this.hideLoadingButton("refreshButton",'<i class="fas fa-sync"></i> Atualizar Lista')}return}if(e==="clearAll"){if(t.length===0){this.showNotification("Nenhum lead encontrado com os filtros aplicados","error");return}if(!confirm(`Tem certeza que deseja excluir ${t.length} leads filtrados? Esta ação é irreversível.`))return;this.showLoadingButton("clearAllButton","Excluindo...");try{await this.deleteFilteredLeads(t),this.showNotification(`${t.length} leads excluídos com sucesso!`,"success")}catch(a){console.error("❌ Erro ao excluir leads:",a),this.showNotification("Erro ao excluir leads: "+a.message,"error")}finally{this.hideLoadingButton("clearAllButton",'<i class="fas fa-trash"></i> Limpar Todos')}return}if(e==="nextAll"||e==="prevAll"){if(t.length===0){this.showNotification("Nenhum lead encontrado com os filtros aplicados","error");return}const o=e==="nextAll"?"avançar":"voltar",a=e==="nextAll"?"nextAllButton":"prevAllButton",s=e==="nextAll"?'<i class="fas fa-forward"></i> Avançar Todos':'<i class="fas fa-backward"></i> Voltar Todos';if(!confirm(`Tem certeza que deseja ${o} ${t.length} leads filtrados?`))return;this.showLoadingButton(a,`${o==="avançar"?"Avançando":"Voltando"}...`);try{await this.updateFilteredLeadsStage(t,e==="nextAll"?1:-1),this.showNotification(`${t.length} leads ${o==="avançar"?"avançados":"voltados"} com sucesso!`,"success")}catch(n){console.error(`❌ Erro ao ${o} leads:`,n),this.showNotification(`Erro ao ${o} leads: `+n.message,"error")}finally{this.hideLoadingButton(a,s)}}}showLoadingButton(e,t){const o=document.getElementById(e);o&&(o.dataset.originalText=o.innerHTML,o.innerHTML=`<i class="fas fa-spinner fa-spin"></i> ${t}`,o.disabled=!0)}hideLoadingButton(e,t){const o=document.getElementById(e);o&&(o.innerHTML=t||o.dataset.originalText||o.innerHTML,o.disabled=!1,delete o.dataset.originalText)}async updateFilteredLeadsStage(e,t){try{const o=JSON.parse(localStorage.getItem("leads")||"[]");let a=0;return e.forEach(s=>{const i=o.findIndex(n=>(n.id||n.cpf)===(s.id||s.cpf));if(i!==-1){const n=o[i].etapa_atual||1,d=Math.max(1,Math.min(16,n+t));d!==n&&(o[i].etapa_atual=d,o[i].updated_at=new Date().toISOString(),a++)}}),localStorage.setItem("leads",JSON.stringify(o)),this.loadLeads(),console.log(`✅ ${a} leads atualizados`),a}catch(o){throw console.error("❌ Erro ao atualizar etapas:",o),o}}async deleteFilteredLeads(e){try{const t=JSON.parse(localStorage.getItem("leads")||"[]"),o=e.map(s=>s.id||s.cpf),a=t.filter(s=>!o.includes(s.id||s.cpf));return localStorage.setItem("leads",JSON.stringify(a)),this.loadLeads(),console.log(`✅ ${e.length} leads excluídos`),e.length}catch(t){throw console.error("❌ Erro ao excluir leads:",t),t}}renderLeadsTable(){const e=document.getElementById("leadsTableBody"),t=document.getElementById("emptyState");if(!e)return;if(this.filteredLeads.length===0){e.innerHTML="",t&&(t.style.display="block");return}t&&(t.style.display="none");const o=(this.currentPage-1)*this.leadsPerPage,a=o+this.leadsPerPage,s=this.filteredLeads.slice(o,a);let i="";s.forEach(n=>{const d=this.selectedLeads.has(n.id||n.cpf),r=Array.isArray(n.produtos)?n.produtos:[],c=r.length>0?r[0].nome:"Produto não informado",l=this.formatCPF(n.cpf||"");i+=`
                <tr style="${d?"background-color: #e3f2fd;":""}">
                    <td>
                        <input type="checkbox" ${d?"checked":""} 
                               onchange="adminPanel.toggleLeadSelection('${n.id||n.cpf}', this.checked)">
                    </td>
                    <td>${n.nome_completo||"N/A"}</td>
                    <td>${l}</td>
                    <td>${n.email||"N/A"}</td>
                    <td>${n.telefone||"N/A"}</td>
                    <td>${c}</td>
                    <td>R$ ${(n.valor_total||0).toFixed(2)}</td>
                    <td>${this.formatDate(n.created_at)}</td>
                    <td>
                        <span class="stage-badge ${this.getStageClass(n.etapa_atual)}">
                            ${n.etapa_atual||1}
                        </span>
                    </td>
                    <td>${this.formatDate(n.updated_at)}</td>
                    <td>
                        <div class="lead-actions">
                            <button class="action-button edit" onclick="adminPanel.editLead('${n.id||n.cpf}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-button next" onclick="adminPanel.nextStage('${n.id||n.cpf}')">
                                <i class="fas fa-forward"></i>
                            </button>
                            <button class="action-button prev" onclick="adminPanel.prevStage('${n.id||n.cpf}')">
                                <i class="fas fa-backward"></i>
                            </button>
                            <button class="action-button delete" onclick="adminPanel.deleteLead('${n.id||n.cpf}')" style="display: none;">
                                <i class="fas fa-trash"></i>
                                <option value="17">17 - Liberado para nova tentativa</option>
                                <option value="18">18 - Liberado, em trânsito</option>
                                <option value="19">19 - Em rota de entrega</option>
                                <option value="20">20 - Tentativa de entrega</option>
                                <option value="21">21 - Liberado para nova tentativa</option>
                                <option value="22">22 - Liberado, em trânsito</option>
                                <option value="23">23 - Em rota de entrega</option>
                                <option value="24">24 - Tentativa de entrega</option>
                                <option value="25">25 - Liberado para nova tentativa</option>
                                <option value="26">26 - Em rota de entrega (final)</option>
                                <option value="17">17 - Liberado para nova tentativa</option>
                                <option value="18">18 - Liberado, em trânsito</option>
                                <option value="19">19 - Em rota de entrega</option>
                                <option value="20">20 - Tentativa de entrega</option>
                                <option value="21">21 - Liberado para nova tentativa</option>
                                <option value="22">22 - Liberado, em trânsito</option>
                                <option value="23">23 - Em rota de entrega</option>
                                <option value="24">24 - Tentativa de entrega</option>
                                <option value="25">25 - Liberado para nova tentativa</option>
                                <option value="26">26 - Em rota de entrega (final)</option>
                            </button>
                        </div>
                    </td>
                </tr>
            `}),e.innerHTML=i,this.updateSelectedCount()}formatCPF(e){const t=e.replace(/[^\d]/g,"");return t.length<=11?t.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/,"$1.$2.$3-$4"):e}toggleLeadSelection(e,t){t?this.selectedLeads.add(e):this.selectedLeads.delete(e),this.updateSelectedCount()}toggleSelectAll(e){const t=document.querySelectorAll('#leadsTableBody input[type="checkbox"]');e?this.filteredLeads.forEach(o=>{this.selectedLeads.add(o.id||o.cpf)}):this.selectedLeads.clear(),t.forEach(o=>{o.checked=e}),this.renderLeadsTable(),this.updateSelectedCount()}updateSelectedCount(){const e=document.getElementById("selectedCount"),t=document.querySelectorAll(".mass-action-button"),o=document.querySelectorAll(".action-count"),a=this.selectedLeads.size;e&&(e.textContent=`${a} selecionados`),t.forEach(s=>{s.disabled=a===0,a===0?(s.style.opacity="0.5",s.style.cursor="not-allowed"):(s.style.opacity="1",s.style.cursor="pointer")}),o.forEach(s=>{s.textContent=`(${a} leads)`})}updateLeadsCount(){const e=document.getElementById("leadsCount");e&&(e.textContent=`${this.filteredLeads.length} leads`)}formatDate(e){if(!e)return"N/A";try{return new Date(e).toLocaleDateString("pt-BR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch{return"Data inválida"}}getStageClass(e){return e>=26?"completed":e>=6?"pending":""}showNotification(e,t="info"){const o=document.createElement("div");switch(o.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 9999;
            animation: slideInRight 0.3s ease;
        `,t){case"success":o.style.background="#28a745";break;case"error":o.style.background="#dc3545";break;default:o.style.background="#007bff"}o.textContent=e,document.body.appendChild(o),setTimeout(()=>{o.style.animation="slideOutRight 0.3s ease",setTimeout(()=>{o.parentNode&&o.remove()},300)},3e3)}handleMassAction(e){if(this.selectedLeads.size===0){this.showNotification("Nenhum lead selecionado","error");return}switch(console.log(`🔧 Ação em massa: ${e} para ${this.selectedLeads.size} leads`),e){case"nextStage":this.massNextStage();break;case"prevStage":this.massPrevStage();break;case"setStage":this.massSetStage();break;case"delete":this.massDeleteLeads();break;default:console.warn("Ação não reconhecida:",e)}}async massNextStage(){if(this.selectedLeads.size===0){this.showNotification("Nenhum lead selecionado","error");return}const e=`Tem certeza que deseja avançar ${this.selectedLeads.size} lead(s) para a próxima etapa?`;if(confirm(e))try{const t=JSON.parse(localStorage.getItem("leads")||"[]");let o=0;this.selectedLeads.forEach(a=>{const s=t.findIndex(i=>(i.id||i.cpf)===a);if(s!==-1){const i=t[s].etapa_atual||1,n=Math.min(16,i+1);t[s].etapa_atual=n,t[s].updated_at=new Date().toISOString(),o++}}),localStorage.setItem("leads",JSON.stringify(t)),this.selectedLeads.clear(),this.loadLeads(),this.showNotification(`${o} lead(s) avançado(s) com sucesso!`,"success"),console.log(`✅ ${o} leads avançados para próxima etapa`)}catch(t){console.error("❌ Erro ao avançar leads:",t),this.showNotification("Erro ao avançar leads: "+t.message,"error")}}async massPrevStage(){if(this.selectedLeads.size===0){this.showNotification("Nenhum lead selecionado","error");return}const e=`Tem certeza que deseja retroceder ${this.selectedLeads.size} lead(s) para a etapa anterior?`;if(confirm(e))try{const t=JSON.parse(localStorage.getItem("leads")||"[]");let o=0;this.selectedLeads.forEach(a=>{const s=t.findIndex(i=>(i.id||i.cpf)===a);if(s!==-1){const i=t[s].etapa_atual||1,n=Math.max(1,i-1);t[s].etapa_atual=n,t[s].updated_at=new Date().toISOString(),o++}}),localStorage.setItem("leads",JSON.stringify(t)),this.selectedLeads.clear(),this.loadLeads(),this.showNotification(`${o} lead(s) retrocedido(s) com sucesso!`,"success"),console.log(`✅ ${o} leads retrocedidos para etapa anterior`)}catch(t){console.error("❌ Erro ao retroceder leads:",t),this.showNotification("Erro ao retroceder leads: "+t.message,"error")}}async massSetStage(){if(this.selectedLeads.size===0){this.showNotification("Nenhum lead selecionado","error");return}const e=prompt(`Digite a etapa desejada (1-16) para ${this.selectedLeads.size} lead(s):`);if(!e)return;const t=parseInt(e);if(isNaN(t)||t<1||t>16){this.showNotification("Etapa inválida. Digite um número entre 1 e 16.","error");return}const o=`Tem certeza que deseja definir a etapa ${t} para ${this.selectedLeads.size} lead(s)?`;if(confirm(o))try{const a=JSON.parse(localStorage.getItem("leads")||"[]");let s=0;this.selectedLeads.forEach(i=>{const n=a.findIndex(d=>(d.id||d.cpf)===i);n!==-1&&(a[n].etapa_atual=t,a[n].updated_at=new Date().toISOString(),s++)}),localStorage.setItem("leads",JSON.stringify(a)),this.selectedLeads.clear(),this.loadLeads(),this.showNotification(`${s} lead(s) definido(s) para etapa ${t} com sucesso!`,"success"),console.log(`✅ ${s} leads definidos para etapa ${t}`)}catch(a){console.error("❌ Erro ao definir etapa dos leads:",a),this.showNotification("Erro ao definir etapa dos leads: "+a.message,"error")}}async massDeleteLeads(){if(this.selectedLeads.size===0){this.showNotification("Nenhum lead selecionado","error");return}const e=`⚠️ ATENÇÃO: Tem certeza que deseja EXCLUIR ${this.selectedLeads.size} lead(s)?

Esta ação não pode ser desfeita!`;if(confirm(e))try{const t=JSON.parse(localStorage.getItem("leads")||"[]");let o=0;const a=t.filter(s=>{const i=s.id||s.cpf;return this.selectedLeads.has(i)?(o++,!1):!0});localStorage.setItem("leads",JSON.stringify(a)),this.selectedLeads.clear(),this.loadLeads(),this.showNotification(`${o} lead(s) excluído(s) com sucesso!`,"success"),console.log(`✅ ${o} leads excluídos`)}catch(t){console.error("❌ Erro ao excluir leads:",t),this.showNotification("Erro ao excluir leads: "+t.message,"error")}}async editLead(e){console.log(`✏️ Editando lead: ${e}`);try{const o=JSON.parse(localStorage.getItem("leads")||"[]").find(a=>(a.id||a.cpf)===e);if(!o){this.showNotification("Lead não encontrado","error");return}this.editingLead=o,this.populateEditForm(o),this.showEditModal()}catch(t){console.error("❌ Erro ao carregar lead para edição:",t),this.showNotification("Erro ao carregar dados do lead","error")}}populateEditForm(e){if(document.getElementById("editName").value=e.nome_completo||"",document.getElementById("editCPF").value=e.cpf||"",document.getElementById("editEmail").value=e.email||"",document.getElementById("editPhone").value=e.telefone||"",document.getElementById("editAddress").value=e.endereco||"",document.getElementById("editStage").value=e.etapa_atual||1,e.updated_at){const t=new Date(e.updated_at),o=new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("editStageDateTime").value=o}else{const t=new Date,o=new Date(t.getTime()-t.getTimezoneOffset()*6e4).toISOString().slice(0,16);document.getElementById("editStageDateTime").value=o}}showEditModal(){const e=document.getElementById("editModal");e&&(e.style.display="flex",document.body.style.overflow="hidden")}closeEditModal(){const e=document.getElementById("editModal");e&&(e.style.display="none",document.body.style.overflow="auto"),this.editingLead=null}async handleEditSubmit(e){if(e.preventDefault(),!this.editingLead){this.showNotification("Nenhum lead selecionado para edição","error");return}try{const t=new FormData(e.target),o={...this.editingLead,nome_completo:document.getElementById("editName").value,cpf:document.getElementById("editCPF").value.replace(/[^\d]/g,""),email:document.getElementById("editEmail").value,telefone:document.getElementById("editPhone").value,endereco:document.getElementById("editAddress").value,etapa_atual:parseInt(document.getElementById("editStage").value),updated_at:new Date().toISOString()},a=JSON.parse(localStorage.getItem("leads")||"[]"),s=a.findIndex(i=>(i.id||i.cpf)===(this.editingLead.id||this.editingLead.cpf));if(s!==-1)a[s]=o,localStorage.setItem("leads",JSON.stringify(a)),this.closeEditModal(),this.loadLeads(),this.showNotification("Lead atualizado com sucesso!","success");else throw new Error("Lead não encontrado para atualização")}catch(t){console.error("❌ Erro ao atualizar lead:",t),this.showNotification("Erro ao atualizar lead: "+t.message,"error")}}async nextStage(e){console.log(`⏭️ Próxima etapa para lead: ${e}`),await this.updateLeadStage(e,1)}async prevStage(e){console.log(`⏮️ Etapa anterior para lead: ${e}`),await this.updateLeadStage(e,-1)}async updateLeadStage(e,t){try{const o=JSON.parse(localStorage.getItem("leads")||"[]"),a=o.findIndex(s=>(s.id||s.cpf)===e);if(a!==-1){const s=o[a].etapa_atual||1,i=Math.max(1,Math.min(26,s+t));o[a].etapa_atual=i,o[a].updated_at=new Date().toISOString(),localStorage.setItem("leads",JSON.stringify(o)),this.loadLeads();const n=t>0?"avançada":"retrocedida";this.showNotification(`Etapa ${n} com sucesso! Nova etapa: ${i}`,"success"),console.log(`✅ Etapa atualizada para ${i}`)}else throw new Error("Lead não encontrado")}catch(o){console.error("❌ Erro ao atualizar etapa:",o),this.showNotification("Erro ao atualizar etapa: "+o.message,"error")}}async deleteLead(e){if(confirm("Tem certeza que deseja excluir este lead?")){console.log(`🗑️ Excluindo lead: ${e}`);try{const t=JSON.parse(localStorage.getItem("leads")||"[]"),o=t.filter(a=>(a.id||a.cpf)!==e);if(t.length===o.length)throw new Error("Lead não encontrado para exclusão");localStorage.setItem("leads",JSON.stringify(o)),this.loadLeads(),this.showNotification("Lead excluído com sucesso!","success")}catch(t){console.error("❌ Erro ao excluir lead:",t),this.showNotification("Erro ao excluir lead","error")}}}}let w=null;document.addEventListener("DOMContentLoaded",()=>{w=new k,window.adminPanel=w});
